#!/usr/bin/python
# -*- coding: utf-8 -*-

DOCUMENTATION = """
module: jenkins-node
short_decription: Manage Jenkins nodes
description:
  - This module provides some management features to control Jenkins
    nodes.

options:
  uri:
    description:
      - Base URI for the Jenkins instance
    required: true

  username:
    description:
      - The username to log-in with.
    required: true

  password:
    description:
      - The password to log-in with.
    required: true

  operation:
    description:
      - Operation to perform
    required: false
    default: 'create'
    choices: [ create, delete, enable, disable ]

  name:
    description:
      - Node name
    required: true

  executors:
    description:
      - Number of executors in node
    required: false
    default: 2

  description:
    description:
      - Description of the node
    required: false
    default: null

  labels:
    description:
      - Labels to associate with a node, like "amd64" or "python"
    required: false
    default: null

  exclusive:
    description:
      - Mark this node for tied jobs only
    required: false
    default: 'no'
    choices: ['no', 'yes']

requirements: ['python-jenkins']
author:
    - "Alfredo Deza"

"""

EXAMPLES = """
# Create new node
- name: Create new node
  jenkins-node: uri={{ jenkins_uri }} username={{ user }} password={{ password }}
           name={{ node_name }} operation=create

# Delete an existing node
- name: Delete a node
  jenkins-node: uri={{ jenkins_uri }} username={{ user }} password={{ password }}
           name={{ node_name }} operation=delete
"""

HAS_JENKINS_API = True
try:
    import jenkins
except ImportError:
    HAS_JENKINS_API = False


def _jenkins(uri, username, password):
    return jenkins.jenkins(uri, username, password)


def create(uri, user, password, name, **kw):
    jenkins = _jenkins(uri, user, password)
    if name in jenkins.jobs:
        return False, "Failed to create job '%s' - already exists." % name
    jenkins.create_job(name, _clean_xml_str(config))
    if name not in jenkins:
        return False, "Failed to create job '%s'." % name
    return True, None


def delete(uri, user, password, name, **kw):
    j = _jenkins(uri, user, password)
    if name not in j:
        return False, "Could not delete '%s' - unknown job." % name
    j.delete_job(name)
    return True, None


def enable(uri, user, password, name, **kw):
    j = _jenkins(uri, user, password)
    if name not in j:
        return False, "Could not enable '%s' - unknown job." % name
    job = j[name]
    if job.is_enabled():
        return False, "Job already enabled"
    else:
        job.enable()
        return True, None


def disable(uri, user, password, name, **kw):
    j = _jenkins(uri, user, password)
    if name not in j:
        return False, "Could not disable '%s' - unknown job." % name
    job = j[name]
    if job.is_enabled():
        job.disable()
        return True, None
    else:
        return False, "Job already disabled"


def main():
    module = AnsibleModule(
        argument_spec=dict(
            uri=dict(required=True),
            username=dict(required=True),
            password=dict(required=True),
            operation=dict(default='create', choices=['create', 'delete', 'enable', 'disable']),
            name=dict(required=True),
            executors=dict(required=False, default=2),
            description=dict(required=False, default=None),
            labels=dict(required=False, default=None),
            exclusive=dict(required=False, default='no', type='bool'),
        ),
        supports_check_mode=False
    )

    if not HAS_JENKINS_API:
        module.fail_json(msg="Could not import python module: jenkins. Please install the python-jenkins package.")

    uri = module.params['uri']
    username = module.params['username']
    password = module.params['password']
    operation = module.params.get('operation', 'create')
    name = module.params['name']
    executors = module.params['executors']
    description = module.params.get('description')
    labels = module.params.get('labels')
    exclusive = module.params.get('exclusive', False)

    api_calls = {
        'create': create,
        'delete': delete,
        'enable': enable,
        'disable': disable
    }

    try:
        func = api_calls[operation]
    except KeyError:
        return module.fail_json(
            msg="operation: %s is not supported. Choose one of: %s'" % (
                operation, str(api_calls.keys()))
        )

    try:
        changed, msg = func(
            uri,
            username,
            password,
            name,
            executors=executors,
            description=description,
            labels=labels,
            exclusive=exclusive
        )
    except Exception as ex:
        return module.fail_json(msg=ex.message)

    args = {'changed': changed}
    if msg:
        args['msg'] = msg
    module.exit_json(**args)


# yep, everything: https://docs.ansible.com/developing_modules.html#common-module-boilerplate
from ansible.module_utils.basic import *
if __name__ == '__main__':
    main()
